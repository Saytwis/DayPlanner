<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Planner</title>
  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0a0f16;
      --panel: rgba(255,255,255,.035);
      --panel2: rgba(0,0,0,.20);
      --line: rgba(255,255,255,.085);
      --line2: rgba(255,255,255,.12);

      --text:#edf2f9;
      --muted:#a9b7c9;

      --acc:#bfc8ff;   /* cool pearl */
      --acc2:#f3d7ff;  /* rose pearl */
      --good:#42e3a1;
      --bad:#ff5c7a;
      --warn:#ffd166;

      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 24px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(191,200,255,.12), transparent 60%),
        radial-gradient(1100px 650px at 80% 0%, rgba(243,215,255,.10), transparent 55%),
        radial-gradient(900px 500px at 50% 110%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Subtle moving grain */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='280'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='280' height='280' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      opacity:.08;
      mix-blend-mode:overlay;
      pointer-events:none;
      animation: grain 8s steps(6) infinite;
    }
    @keyframes grain{
      0%{transform:translate(0,0)}
      20%{transform:translate(-2%,1%)}
      40%{transform:translate(2%,-1%)}
      60%{transform:translate(-1%,-2%)}
      80%{transform:translate(1%,2%)}
      100%{transform:translate(0,0)}
    }

    /* Layout */
    .shell{
      max-width:1120px;
      margin:0 auto;
      padding:16px 14px 28px;
      display:grid;
      gap:12px;
      grid-template-columns: 1.25fr .75fr;
      align-items:start;
    }
    @media(max-width:980px){
      .shell{grid-template-columns:1fr}
    }

    /* Luxe top bar */
    .topbar{
      max-width:1120px;
      margin:0 auto;
      padding:14px 14px 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .mark{
      width:34px; height:34px; border-radius:12px;
      border:1px solid var(--line);
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(255,255,255,.14), transparent 65%),
        linear-gradient(135deg, rgba(191,200,255,.20), rgba(243,215,255,.12));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }
    .mark::after{
      content:"";
      position:absolute; inset:-40%;
      background:linear-gradient(120deg, transparent 35%, rgba(255,255,255,.22) 50%, transparent 65%);
      transform:translateX(-40%) rotate(10deg);
      animation: shimmer 5.6s ease-in-out infinite;
      opacity:.8;
    }
    @keyframes shimmer{
      0%{transform:translateX(-60%) rotate(10deg)}
      35%{transform:translateX(60%) rotate(10deg)}
      100%{transform:translateX(60%) rotate(10deg)}
    }
    .brand h1{
      margin:0;
      font-size:13px;
      letter-spacing: .22em;
      text-transform:uppercase;
      color:rgba(237,242,249,.92);
    }
    .brand span{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.06em;
      margin-top:2px;
    }

    /* Cards */
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      transform: translateZ(0);
      animation: popIn .45s ease both;
    }
    @keyframes popIn{
      from{opacity:0; transform:translateY(6px)}
      to{opacity:1; transform:translateY(0)}
    }

    .bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background: rgba(0,0,0,.22);
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .content{padding:12px}

    /* Pills/buttons */
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12px}

    .pill{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
      transition:.18s;
    }
    .pill b{color:var(--text); font-weight:800}

    .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 3px rgba(255,209,102,.12);
    }
    .dot.ok{background:var(--good); box-shadow:0 0 0 3px rgba(66,227,161,.12)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(255,92,122,.12)}

    .btn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius: 16px;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      transition: transform .16s ease, border-color .16s ease, background .16s ease;
      user-select:none;
    }
    .btn:hover{
      border-color: rgba(255,255,255,.18);
      transform: translateY(-1px);
      background: rgba(255,255,255,.04);
    }
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      border-color: rgba(191,200,255,.30);
      background: linear-gradient(135deg, rgba(191,200,255,.12), rgba(243,215,255,.10));
    }
    .btn.good{
      border-color: rgba(66,227,161,.30);
      background: rgba(66,227,161,.08);
    }
    .btn.bad{
      border-color: rgba(255,92,122,.32);
      background: rgba(255,92,122,.08);
    }
    .btn.small{padding:7px 9px; font-size:12px; border-radius:14px}

    /* Inputs */
    input, select, textarea{
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color:var(--text);
      border-radius: 16px;
      padding:8px 10px;
      font-size:13px;
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(191,200,255,.30);
      box-shadow: 0 0 0 3px rgba(191,200,255,.10);
    }
    textarea{min-height:70px; resize:vertical}

    /* Tabs */
    .seg{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .seg button{
      border:0;
      background: transparent;
      color:var(--muted);
      padding:8px 10px;
      cursor:pointer;
      font-size:12px;
      transition:.18s;
    }
    .seg button.active{
      color:var(--text);
      background: linear-gradient(90deg, rgba(191,200,255,.12), rgba(243,215,255,.10));
    }

    /* No popups confirm bar */
    .confirmBar{
      border:1px dashed rgba(255,209,102,.40);
      background: rgba(255,209,102,.06);
      border-radius: 18px;
      padding:10px;
      display:none;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      animation: fadeSlide .22s ease both;
    }
    .confirmBar.show{display:flex}
    @keyframes fadeSlide{
      from{opacity:0; transform:translateY(6px)}
      to{opacity:1; transform:translateY(0)}
    }
    .confirmBar .msg{color:var(--muted); font-size:12px; line-height:1.35}

    /* Planner inner layout */
    .split{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
      margin-top:12px;
    }
    @media(max-width:980px){
      .split{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }
    .panel .pbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.22);
      flex-wrap:wrap;
    }
    .panel .pbody{padding:10px}

    .sectionTitle{
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:11px;
      color:rgba(237,242,249,.78);
    }

    /* Lists */
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}

    .item{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(0,0,0,.14);
      padding:10px;
      display:grid;
      gap:10px;
      align-items:center;
      transition: transform .14s ease, border-color .14s ease, background .14s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }

    /* Checklist item */
    .todo{grid-template-columns: 26px 1fr auto}

    .check{
      width:18px;height:18px;border-radius:7px;
      border:1px solid var(--line);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .check:active{transform: scale(.96)}
    .check.done{
      border-color: rgba(66,227,161,.40);
      background: rgba(66,227,161,.10);
    }
    .check.done::after{
      content:"✓";
      color:var(--good);
      font-weight:900;
      font-size:12px;
    }

    .name{
      outline:none;
      border-radius: 14px;
      padding:2px 6px;
      min-height:22px;
    }
    .name:focus{
      box-shadow:0 0 0 3px rgba(191,200,255,.10);
      background: rgba(191,200,255,.06);
    }

    /* Schedule item */
    .block{grid-template-columns: 70px 1fr auto}

    .timeBox{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:7px 8px;
      display:flex; flex-direction:column; gap:3px;
      align-items:flex-start;
      min-width:70px;
    }
    .timeBox b{color:var(--text); font-weight:900}

    .mini{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tag{
      font-size:11px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:2px 8px;
      color:var(--muted);
      background: rgba(0,0,0,.18);
      font-family:var(--mono);
    }
    .tag.pearl{
      border-color: rgba(191,200,255,.22);
      color: rgba(191,200,255,.82);
    }

    /* Timeline */
    .timeline{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.14);
      padding:10px;
      margin-top:12px;
      animation: popIn .35s ease both;
    }
    .tlRow{
      display:grid;
      grid-template-columns: 56px 1fr;
      gap:10px;
      align-items:stretch;
      padding:8px 0;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .tlRow:first-child{border-top:0}
    .tlTime{
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
      padding-top:4px;
    }
    .tlCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
      padding:8px 10px;
      display:flex; flex-direction:column; gap:6px;
    }
    .tlTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .tlTitle{font-weight:900; font-size:13px}
    .tlMeta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    /* Calendar */
    .calDow{font-size:11px;color:var(--muted);text-align:center;padding:6px 0;}
    .calDay{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(0,0,0,.14);
      min-height:70px;
      padding:8px;
      cursor:pointer;
      position:relative;
      user-select:none;
      transition: transform .14s ease, border-color .14s ease, background .14s ease;
    }
    .calDay:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }
    .calDay.selected{
      border-color: rgba(191,200,255,.28);
      box-shadow: 0 0 0 3px rgba(191,200,255,.08);
      transform:none;
    }
    .calNum{font-size:12px;color:var(--muted);font-family:var(--mono)}
    .calMark{position:absolute;right:10px;top:10px;font-weight:900;font-size:16px;font-family:var(--mono)}
    .calMark.good{color:var(--good)}
    .calMark.bad{color:var(--bad)}
    .calHint{position:absolute;left:10px;bottom:10px;display:flex;gap:6px;flex-wrap:wrap;opacity:.9}
    .calMiniDot{width:7px;height:7px;border-radius:50%;background:rgba(169,183,201,.25);border:1px solid rgba(255,255,255,.08)}
    .calMiniDot.on{background:rgba(191,200,255,.45)}
    .calMiniDot.done{background:rgba(66,227,161,.45)}

    /* Toast */
    .toast{
      position:fixed;
      left:16px;
      bottom:16px;
      width:min(560px, calc(100% - 32px));
      border:1px solid var(--line);
      border-radius: 20px;
      background: rgba(10,14,20,.86);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:12px;
      display:none;
      gap:10px;
      align-items:flex-start;
      z-index:50;
      animation: fadeSlide .22s ease both;
    }
    .toast.show{display:flex}
    .toast .tTitle{font-weight:950; font-size:13px; letter-spacing:.02em}
    .toast .tBody{color:var(--muted); font-size:12px; line-height:1.35}
    .toast .tActions{margin-left:auto; display:flex; gap:8px; align-items:center}
    .toast .badge{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(0,0,0,.18);
    }

    /* Key pane polish */
    .keyWrap{
      display:flex; flex-direction:column; gap:10px;
      padding:8px 2px 2px;
    }
    .keyRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
      body::before{animation:none !important}
    }
  </style>
</head>

<body>
  <!-- Top luxe bar (no long text) -->
  <div class="topbar">
    <div class="brand">
      <div class="mark" aria-hidden="true"></div>
      <div>
        <h1>PLANNER</h1>
        <span id="selLabel">—</span>
      </div>
    </div>

    <div class="row">
      <span class="pill">Sync: <span id="syncDot" class="dot"></span> <b id="syncLabel">locked</b></span>
      <span class="pill">Key: <b id="keyLabel">not set</b></span>
    </div>
  </div>

  <div class="shell">
    <!-- LEFT: Planner -->
    <section class="card">
      <div class="bar">
        <div class="row">
          <button class="btn" id="pullBtn">Pull</button>
          <button class="btn" id="pushBtn">Push</button>
          <button class="btn" id="clearKeyBtn">Clear key</button>
        </div>
        <div class="row">
          <span class="pill">Progress: <b id="progress">0/0</b></span>
          <span class="pill">Mode: <b id="modeLabel">Day</b></span>
        </div>
      </div>

      <!-- Key gate -->
      <div class="content" id="keyPane">
        <div class="keyWrap">
          <div class="keyRow">
            <input id="keyInput" type="password" placeholder="Planner Key" style="min-width:320px"/>
            <button class="btn primary" id="unlockBtn">Unlock</button>
          </div>
          <div class="muted">Same key on each device = same planner. (Stored locally; not recoverable.)</div>
        </div>
      </div>

      <!-- Planner -->
      <div class="content" id="plannerPane" style="display:none">
        <div class="bar" style="border:1px solid var(--line);border-radius:20px;margin-bottom:12px">
          <div class="row">
            <span class="pill">Date: <b><input id="datePick" type="date"/></b></span>

            <span class="seg">
              <button id="tabDay" class="active">Day</button>
              <button id="tabTemplate">Template</button>
            </span>

            <span class="seg">
              <button id="tabMain" class="active">Checklist + Schedule</button>
              <button id="tabTimeline">Timeline</button>
            </span>
          </div>

          <div class="row">
            <button class="btn primary" id="addTodoBtn">+ Checklist</button>
            <button class="btn primary" id="addBlockBtn">+ Schedule</button>
            <button class="btn" id="applyTplBtn">Apply template → day</button>
            <button class="btn good" id="lockBtn">Lock day (auto ✅/❌)</button>
          </div>
        </div>

        <!-- Inline Add Panels (no prompts) -->
        <div class="panel" id="addPanel" style="display:none">
          <div class="pbar">
            <div class="row">
              <div class="sectionTitle" id="addTitleLabel">ADD</div>
              <span class="pill" id="addTypePill">—</span>
            </div>
            <div class="row">
              <button class="btn small" id="hideAddBtn">Hide</button>
            </div>
          </div>
          <div class="pbody">
            <div class="row" style="align-items:flex-end">
              <div style="flex:1; min-width:220px">
                <div class="muted" style="margin:0 0 6px">Title</div>
                <input id="addTitle" placeholder="e.g., 90-min Study Block / Rings Workout" style="width:100%"/>
              </div>

              <div id="addSchedFields" class="row" style="display:none">
                <div>
                  <div class="muted" style="margin:0 0 6px">Start</div>
                  <input id="addStart" type="time" value="09:00"/>
                </div>
                <div>
                  <div class="muted" style="margin:0 0 6px">Duration</div>
                  <select id="addDur">
                    <option value="30">30m</option>
                    <option value="45">45m</option>
                    <option value="60">60m</option>
                    <option value="75">75m</option>
                    <option value="90" selected>90m</option>
                    <option value="120">120m</option>
                  </select>
                </div>
                <div>
                  <div class="muted" style="margin:0 0 6px">Tag</div>
                  <select id="addTag">
                    <option value="deep">deep</option>
                    <option value="workout">workout</option>
                    <option value="admin">admin</option>
                    <option value="focus">focus</option>
                    <option value="life">life</option>
                  </select>
                </div>
              </div>

              <button class="btn primary" id="addCommit">Add</button>
            </div>

            <div class="confirmBar" id="confirmBar">
              <div class="msg" id="confirmMsg">Confirm?</div>
              <div class="row">
                <button class="btn bad" id="confirmYes">Yes</button>
                <button class="btn" id="confirmNo">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- MAIN: Checklist + Schedule same page -->
        <div id="mainPane">
          <div class="split">
            <!-- Checklist -->
            <div class="panel">
              <div class="pbar">
                <div class="row">
                  <div class="sectionTitle">CHECKLIST</div>
                  <span class="pill"><b id="todoCount">0</b> items</span>
                </div>
                <div class="row">
                  <span class="pill">Done: <b id="todoDone">0</b></span>
                </div>
              </div>
              <div class="pbody">
                <div class="list" id="todoList"></div>
              </div>
            </div>

            <!-- Schedule -->
            <div class="panel">
              <div class="pbar">
                <div class="row">
                  <div class="sectionTitle">SCHEDULE</div>
                  <span class="pill"><b id="blockCount">0</b> blocks</span>
                </div>
                <div class="row">
                  <span class="pill">Style: <b>Minimal</b></span>
                </div>
              </div>
              <div class="pbody">
                <div class="list" id="blockList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- TIMELINE separate tab -->
        <div id="timelinePane" style="display:none">
          <div class="timeline" id="timeline"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Calendar -->
    <aside class="card">
      <div class="bar">
        <div class="row" style="justify-content:space-between; width:100%">
          <button class="btn" id="prevMonthBtn">←</button>
          <div class="pill"><b id="calTitle">Month YYYY</b></div>
          <button class="btn" id="nextMonthBtn">→</button>
        </div>
      </div>

      <div class="content">
        <div id="calDow" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px;"></div>
        <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;"></div>

        <div class="muted" style="margin-top:10px;line-height:1.35">
          ✅/❌ after lock. Dots indicate checklist/schedule activity.
        </div>
      </div>
    </aside>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div>
      <div class="tTitle" id="toastTitle">Title</div>
      <div class="tBody" id="toastBody">Body</div>
    </div>
    <div class="tActions">
      <span class="badge" id="toastBadge">info</span>
      <button class="btn small" id="toastClose">Close</button>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ✅ Supabase Settings → API
  const SUPABASE_URL = "https://lugcbtddrzpkfrlpawuq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1Z2NidGRkcnpwa2ZybHBhd3VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjQxNzAsImV4cCI6MjA4NTU0MDE3MH0.H3lp8QSMWQsUbCEEK-U4SZKM7oAv8tXUTq99AK7QQK0";

  // Key hash header
  let keyHash = localStorage.getItem("PLANNER_KEY_HASH") || "";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    global: {
      fetch: (url, options = {}) => {
        const headers = new Headers(options.headers || {});
        if (keyHash) headers.set("x-planner-key-hash", keyHash);
        return fetch(url, { ...options, headers });
      }
    }
  });

  // ---------- DOM ----------
  const syncDot = document.getElementById("syncDot");
  const syncLabel = document.getElementById("syncLabel");
  const keyLabel = document.getElementById("keyLabel");
  const selLabel = document.getElementById("selLabel");

  const keyPane = document.getElementById("keyPane");
  const plannerPane = document.getElementById("plannerPane");
  const keyInput = document.getElementById("keyInput");
  const unlockBtn = document.getElementById("unlockBtn");
  const clearKeyBtn = document.getElementById("clearKeyBtn");
  const pullBtn = document.getElementById("pullBtn");
  const pushBtn = document.getElementById("pushBtn");

  const datePick = document.getElementById("datePick");
  const tabDay = document.getElementById("tabDay");
  const tabTemplate = document.getElementById("tabTemplate");
  const modeLabel = document.getElementById("modeLabel");

  const tabMain = document.getElementById("tabMain");
  const tabTimeline = document.getElementById("tabTimeline");
  const mainPane = document.getElementById("mainPane");
  const timelinePane = document.getElementById("timelinePane");

  const applyTplBtn = document.getElementById("applyTplBtn");
  const lockBtn = document.getElementById("lockBtn");

  const progressEl = document.getElementById("progress");

  const addTodoBtn = document.getElementById("addTodoBtn");
  const addBlockBtn = document.getElementById("addBlockBtn");
  const addPanel = document.getElementById("addPanel");
  const addTitleLabel = document.getElementById("addTitleLabel");
  const addTypePill = document.getElementById("addTypePill");
  const hideAddBtn = document.getElementById("hideAddBtn");
  const addTitle = document.getElementById("addTitle");
  const addSchedFields = document.getElementById("addSchedFields");
  const addStart = document.getElementById("addStart");
  const addDur = document.getElementById("addDur");
  const addTag = document.getElementById("addTag");
  const addCommit = document.getElementById("addCommit");

  const confirmBar = document.getElementById("confirmBar");
  const confirmMsg = document.getElementById("confirmMsg");
  const confirmYes = document.getElementById("confirmYes");
  const confirmNo = document.getElementById("confirmNo");

  const todoList = document.getElementById("todoList");
  const blockList = document.getElementById("blockList");
  const todoCount = document.getElementById("todoCount");
  const todoDone = document.getElementById("todoDone");
  const blockCount = document.getElementById("blockCount");

  const timeline = document.getElementById("timeline");

  const calTitle = document.getElementById("calTitle");
  const calGrid  = document.getElementById("calGrid");
  const calDow   = document.getElementById("calDow");
  const prevMonthBtn = document.getElementById("prevMonthBtn");
  const nextMonthBtn = document.getElementById("nextMonthBtn");
  const DOW = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  const toast = document.getElementById("toast");
  const toastTitle = document.getElementById("toastTitle");
  const toastBody = document.getElementById("toastBody");
  const toastBadge = document.getElementById("toastBadge");
  const toastClose = document.getElementById("toastClose");

  // ---------- Helpers ----------
  const pad2 = (n) => String(n).padStart(2,"0");
  const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISO = (s) => { const [y,m,dd]=s.split("-").map(Number); return new Date(y,m-1,dd); };
  const wdMonFirst = (date) => (date.getDay() + 6) % 7;
  const wdName = (i) => ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][i];
  const maskHash = (h) => !h ? "not set" : (h.slice(0,6) + "…" + h.slice(-6));

  function setSync(status, label){
    syncDot.classList.toggle("ok", status==="ok");
    syncDot.classList.toggle("bad", status==="bad");
    syncLabel.textContent = label || status;
  }

  // Toast
  toastClose.addEventListener("click", ()=> toast.classList.remove("show"));
  let toastTimer = null;
  function quickToast(title, body, badge="info", ms=2400){
    toastTitle.textContent = title;
    toastBody.textContent = body;
    toastBadge.textContent = badge;
    toast.classList.add("show");
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove("show"), ms);
  }

  // Inline confirm
  let confirmAction = null;
  function askConfirm(msg, action){
    confirmMsg.textContent = msg;
    confirmBar.classList.add("show");
    confirmAction = action;
  }
  function clearConfirm(){
    confirmBar.classList.remove("show");
    confirmAction = null;
  }
  confirmYes.addEventListener("click", ()=>{ if(confirmAction) confirmAction(); clearConfirm(); });
  confirmNo.addEventListener("click", clearConfirm);

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  // ---------- Data model ----------
  const mkTodo = (name) => ({ id: crypto.randomUUID(), name });
  const mkBlock = (title, start="09:00", durMin=90, tag="deep") =>
    ({ id: crypto.randomUUID(), title, start, durMin, tag, notes:"" });

  const defaultState = {
    templates: {
      0: { todos:[mkTodo("Workout"), mkTodo("Study block")], blocks:[mkBlock("90-min Study", "09:00", 90, "deep"), mkBlock("Workout", "17:30", 60, "workout")] },
      1: { todos:[mkTodo("Workout"), mkTodo("Project work")], blocks:[mkBlock("Project Build", "10:00", 90, "focus")] },
      2: { todos:[mkTodo("Workout"), mkTodo("90-min study")], blocks:[mkBlock("Deep Study", "09:00", 90, "deep")] },
      3: { todos:[mkTodo("Workout"), mkTodo("Reading 10 pages")], blocks:[mkBlock("Reading", "20:00", 30, "life")] },
      4: { todos:[mkTodo("Workout"), mkTodo("Weekly review")], blocks:[mkBlock("Review", "18:00", 45, "admin")] },
      5: { todos:[mkTodo("Workout"), mkTodo("Life reset")], blocks:[mkBlock("Reset + Plan", "12:00", 60, "life")] },
      6: { todos:[mkTodo("Walk"), mkTodo("Prep week")], blocks:[mkBlock("Walk", "16:00", 45, "workout")] },
    },
    days: {}
  };

  let state = structuredClone(defaultState);
  let selectedDate = toISO(new Date());
  let mode = "day";          // day | template
  let view = "main";         // main | timeline
  let calendarMonth = new Date(); calendarMonth.setDate(1);

  datePick.value = selectedDate;

  function ensureDay(dateStr){
    if(!state.days[dateStr]){
      const wd = wdMonFirst(parseISO(dateStr));
      const tpl = state.templates[wd] || { todos:[], blocks:[] };
      const day = { todos: structuredClone(tpl.todos||[]), todoChecks:{}, blocks: structuredClone(tpl.blocks||[]), locked:false, result:null };
      for(const t of day.todos) day.todoChecks[t.id] = false;
      state.days[dateStr] = day;
    } else {
      const day = state.days[dateStr];
      day.todos ||= [];
      day.todoChecks ||= {};
      day.blocks ||= [];
      for(const t of day.todos){
        if(typeof day.todoChecks[t.id] !== "boolean") day.todoChecks[t.id] = false;
      }
      for(const tid of Object.keys(day.todoChecks)){
        if(!day.todos.some(t => t.id === tid)) delete day.todoChecks[tid];
      }
    }
  }

  function workingObj(){
    const wd = wdMonFirst(parseISO(selectedDate));
    if(mode === "template"){
      if(!state.templates[wd]) state.templates[wd] = { todos:[], blocks:[] };
      return { type:"template", wd, obj: state.templates[wd] };
    }
    ensureDay(selectedDate);
    return { type:"day", obj: state.days[selectedDate] };
  }

  function computeAutoResult(dateStr){
    ensureDay(dateStr);
    const day = state.days[dateStr];
    const allDone = (day.todos||[]).every(t => !!day.todoChecks[t.id]);
    return allDone ? "pass" : "fail";
  }

  function minutesToEnd(start, durMin){
    const [hh,mm] = (start||"09:00").split(":").map(Number);
    const total = hh*60 + mm + Number(durMin||0);
    const endH = Math.floor(total/60)%24;
    const endM = total%60;
    return `${pad2(endH)}:${pad2(endM)}`;
  }

  // ---------- Render ----------
  function renderHeader(){
    const wd = wdMonFirst(parseISO(selectedDate));
    selLabel.textContent = `${selectedDate} • ${wdName(wd)}`;
    modeLabel.textContent = (mode === "day") ? "Day" : "Template";
    keyLabel.textContent = maskHash(keyHash);
  }

  function render(){
    renderHeader();

    tabDay.classList.toggle("active", mode==="day");
    tabTemplate.classList.toggle("active", mode==="template");

    tabMain.classList.toggle("active", view==="main");
    tabTimeline.classList.toggle("active", view==="timeline");

    mainPane.style.display = (view==="main") ? "block" : "none";
    timelinePane.style.display = (view==="timeline") ? "block" : "none";

    applyTplBtn.style.display = (mode==="day") ? "inline-block" : "none";
    lockBtn.style.display = (mode==="day") ? "inline-block" : "none";

    const w = workingObj();
    const isDay = (w.type === "day");
    const locked = isDay ? !!w.obj.locked : false;

    // Counts / Progress
    const todos = w.obj.todos || [];
    const blocks = (w.obj.blocks || []).slice().sort((a,b)=> (a.start||"").localeCompare(b.start||""));
    let done = 0;
    if(isDay){
      for(const t of todos) if(w.obj.todoChecks?.[t.id]) done++;
      progressEl.textContent = `${done}/${todos.length}`;
    } else {
      progressEl.textContent = `${todos.length}/${todos.length}`;
    }
    todoCount.textContent = String(todos.length);
    todoDone.textContent  = String(done);
    blockCount.textContent = String(blocks.length);

    // Add panel behavior depends on mode + locked
    if(isDay && locked){
      // still allow viewing, but block edits by disabling inputs in event handlers
    }

    // Checklist
    todoList.innerHTML = "";
    for(const t of todos){
      const row = document.createElement("div");
      row.className = "item todo";

      const chk = document.createElement("div");
      const isDone = isDay ? !!w.obj.todoChecks?.[t.id] : false;
      chk.className = "check" + (isDone ? " done" : "");
      chk.title = isDay ? (locked ? "Day is locked" : "Toggle done") : "Template (no checkmarks)";
      chk.addEventListener("click", () => {
        if(!isDay || locked) return;
        w.obj.todoChecks[t.id] = !w.obj.todoChecks[t.id];
        markDirty();
        render();
      });

      const name = document.createElement("div");
      name.className = "name";
      name.contentEditable = "true";
      name.spellcheck = false;
      name.textContent = t.name;
      name.addEventListener("blur", () => {
        if(isDay && locked) { render(); return; }
        t.name = (name.textContent || "").trim() || "Untitled";
        markDirty();
        render();
      });

      const del = document.createElement("button");
      del.className = "btn small";
      del.textContent = "Delete";
      del.addEventListener("click", () => {
        askConfirm(`Delete checklist item "${t.name}"?`, () => {
          if(isDay && locked) { quickToast("Locked", "This day is locked.", "locked"); return; }
          w.obj.todos = (w.obj.todos||[]).filter(x => x.id !== t.id);
          if(isDay) delete w.obj.todoChecks?.[t.id];
          markDirty();
          render();
          quickToast("Deleted", "Checklist item removed.", "ok");
        });
      });

      row.appendChild(chk);
      row.appendChild(name);
      row.appendChild(del);
      todoList.appendChild(row);
    }

    // Schedule
    blockList.innerHTML = "";
    for(const b of blocks){
      const row = document.createElement("div");
      row.className = "item block";

      const time = document.createElement("div");
      time.className = "timeBox";
      const end = minutesToEnd(b.start || "09:00", b.durMin || 60);
      time.innerHTML = `<b>${b.start || "—"}</b><span>${end}</span>`;

      const body = document.createElement("div");

      const title = document.createElement("div");
      title.className = "name";
      title.contentEditable = "true";
      title.spellcheck = false;
      title.textContent = b.title || "Untitled block";
      title.addEventListener("blur", () => {
        if(isDay && locked) { render(); return; }
        b.title = (title.textContent || "").trim() || "Untitled block";
        markDirty();
        render();
      });

      const meta = document.createElement("div");
      meta.className = "mini";

      const startIn = document.createElement("input");
      startIn.type = "time";
      startIn.value = b.start || "09:00";
      startIn.disabled = (isDay && locked);
      startIn.addEventListener("change", ()=>{
        b.start = startIn.value || "09:00";
        markDirty();
        render();
      });

      const durSel = document.createElement("select");
      for(const v of [30,45,60,75,90,120]){
        const opt = document.createElement("option");
        opt.value = String(v);
        opt.textContent = `${v}m`;
        if(Number(b.durMin||60) === v) opt.selected = true;
        durSel.appendChild(opt);
      }
      durSel.disabled = (isDay && locked);
      durSel.addEventListener("change", ()=>{
        b.durMin = Number(durSel.value || 60);
        markDirty();
        render();
      });

      const tagSel = document.createElement("select");
      for(const tag of ["deep","workout","admin","focus","life"]){
        const opt = document.createElement("option");
        opt.value = tag;
        opt.textContent = tag;
        if((b.tag||"deep") === tag) opt.selected = true;
        tagSel.appendChild(opt);
      }
      tagSel.disabled = (isDay && locked);
      tagSel.addEventListener("change", ()=>{
        b.tag = tagSel.value || "deep";
        markDirty();
        render();
      });

      const tag = document.createElement("span");
      tag.className = "tag pearl";
      tag.textContent = b.tag || "deep";

      meta.appendChild(startIn);
      meta.appendChild(durSel);
      meta.appendChild(tagSel);
      meta.appendChild(tag);

      const notes = document.createElement("textarea");
      notes.placeholder = "Notes (optional)";
      notes.value = b.notes || "";
      notes.disabled = (isDay && locked);
      notes.addEventListener("blur", ()=>{
        b.notes = (notes.value || "").trim();
        markDirty();
      });

      body.appendChild(title);
      body.appendChild(meta);
      body.appendChild(notes);

      const actions = document.createElement("div");
      actions.className = "row";
      actions.style.justifyContent = "flex-end";

      const del = document.createElement("button");
      del.className = "btn small";
      del.textContent = "Delete";
      del.addEventListener("click", () => {
        askConfirm(`Delete schedule block "${b.title}"?`, () => {
          if(isDay && locked) { quickToast("Locked", "This day is locked.", "locked"); return; }
          w.obj.blocks = (w.obj.blocks||[]).filter(x => x.id !== b.id);
          markDirty();
          render();
          quickToast("Deleted", "Schedule block removed.", "ok");
        });
      });

      actions.appendChild(del);

      row.appendChild(time);
      row.appendChild(body);
      row.appendChild(actions);
      blockList.appendChild(row);
    }

    // Timeline (separate tab)
    if(view === "timeline"){
      timeline.innerHTML = "";
      if(blocks.length === 0){
        timeline.innerHTML = `<div class="muted">No schedule blocks yet.</div>`;
      } else {
        for(const b of blocks){
          const row = document.createElement("div");
          row.className = "tlRow";

          const t = document.createElement("div");
          t.className = "tlTime";
          const end = minutesToEnd(b.start || "09:00", b.durMin || 60);
          t.textContent = `${b.start || "—"}–${end}`;

          const card = document.createElement("div");
          card.className = "tlCard";

          const top = document.createElement("div");
          top.className = "tlTop";

          const title = document.createElement("div");
          title.className = "tlTitle";
          title.textContent = b.title || "Untitled block";

          const meta = document.createElement("div");
          meta.className = "tlMeta";

          const tag = document.createElement("span");
          tag.className = "tag pearl";
          tag.textContent = (b.tag || "deep");

          const dur = document.createElement("span");
          dur.className = "tag";
          dur.textContent = `${b.durMin||60}m`;

          meta.appendChild(tag);
          meta.appendChild(dur);

          top.appendChild(title);
          top.appendChild(meta);

          const notes = document.createElement("div");
          notes.className = "muted";
          notes.textContent = (b.notes || "").trim() ? b.notes : "—";

          card.appendChild(top);
          card.appendChild(notes);

          row.appendChild(t);
          row.appendChild(card);
          timeline.appendChild(row);
        }
      }
    }

    renderCalendar();
  }

  // ---------- Calendar ----------
  function renderCalendar(){
    if(calDow.childElementCount === 0){
      for(const d of DOW){
        const el = document.createElement("div");
        el.className = "calDow";
        el.textContent = d;
        calDow.appendChild(el);
      }
    }

    const y = calendarMonth.getFullYear();
    const m = calendarMonth.getMonth();
    const monthName = calendarMonth.toLocaleString(undefined, { month:"long" });
    calTitle.textContent = `${monthName} ${y}`;

    const first = new Date(y, m, 1);
    const firstDay = (first.getDay() + 6) % 7;
    const daysInMonth = new Date(y, m+1, 0).getDate();

    calGrid.innerHTML = "";

    for(let i=0;i<firstDay;i++){
      const blank = document.createElement("div");
      blank.style.opacity = 0;
      blank.style.pointerEvents = "none";
      blank.className = "calDay";
      calGrid.appendChild(blank);
    }

    for(let d=1; d<=daysInMonth; d++){
      const dateStr = `${y}-${pad2(m+1)}-${pad2(d)}`;
      ensureDay(dateStr);
      const day = state.days[dateStr];

      const cell = document.createElement("div");
      cell.className = "calDay" + (dateStr === selectedDate ? " selected" : "");
      cell.addEventListener("click", () => {
        selectedDate = dateStr;
        datePick.value = selectedDate;
        ensureDay(selectedDate);
        markDirty();
        render();
      });

      const num = document.createElement("div");
      num.className = "calNum";
      num.textContent = d;
      cell.appendChild(num);

      if(day.locked && day.result){
        const mark = document.createElement("div");
        mark.className = "calMark " + (day.result === "pass" ? "good" : "bad");
        mark.textContent = (day.result === "pass") ? "✓" : "✗";
        cell.appendChild(mark);
      }

      // dots: has checklist? has schedule? any done?
      const hint = document.createElement("div");
      hint.className = "calHint";

      const dot1 = document.createElement("span");
      dot1.className = "calMiniDot" + ((day.todos||[]).length ? " on" : "");
      const dot2 = document.createElement("span");
      dot2.className = "calMiniDot" + ((day.blocks||[]).length ? " on" : "");
      const anyDone = (day.todos||[]).some(t => day.todoChecks?.[t.id]);
      const dot3 = document.createElement("span");
      dot3.className = "calMiniDot" + (anyDone ? " done" : "");

      hint.appendChild(dot1);
      hint.appendChild(dot2);
      hint.appendChild(dot3);
      cell.appendChild(hint);

      calGrid.appendChild(cell);
    }
  }

  prevMonthBtn.addEventListener("click", () => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth()-1, 1);
    renderCalendar();
  });
  nextMonthBtn.addEventListener("click", () => {
    calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth()+1, 1);
    renderCalendar();
  });

  // ---------- Sync ----------
  let dirty = false;
  let saveTimer = null;

  function markDirty(){
    dirty = true;
    setSync("warn", "pending…");
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => pushState(false), 1000);
  }

  function requireKey(){
    if(!keyHash){
      setSync("bad", "locked");
      quickToast("Planner Key required", "Set a key to enable sync.", "locked");
      return false;
    }
    return true;
  }

  async function pullState(){
    if(!requireKey()) return;

    setSync("warn", "pulling…");
    const { data, error } = await supabase
      .from("shared_planner")
      .select("state")
      .eq("key_hash", keyHash)
      .maybeSingle();

    if(error){
      console.error(error);
      setSync("bad", "pull failed");
      quickToast("Pull failed", error.message || "Unknown error", "error", 4200);
      return;
    }

    if(data?.state){
      state = data.state;
      if(!state?.templates || !state?.days) state = structuredClone(defaultState);
      ensureDay(selectedDate);
      dirty = false;
      setSync("ok", "synced");
      quickToast("Synced", "Pulled latest state.", "ok");
      render();
    } else {
      state = structuredClone(defaultState);
      ensureDay(selectedDate);
      await pushState(true);
      setSync("ok", "initialized");
      quickToast("Initialized", "Created cloud row.", "ok");
      render();
    }
  }

  async function pushState(force){
    if(!requireKey()) return;

    if(!dirty && !force){
      setSync("ok","synced");
      return;
    }

    ensureDay(selectedDate);
    setSync("warn", "saving…");

    const { error } = await supabase
      .from("shared_planner")
      .upsert({
        key_hash: keyHash,
        state: state,
        updated_at: new Date().toISOString()
      }, { onConflict: "key_hash" });

    if(error){
      console.error(error);
      setSync("bad", "push failed");
      quickToast("Push failed", error.message || "Unknown error", "error", 4200);
      return;
    }

    dirty = false;
    setSync("ok", "synced");
  }

  // ---------- Key gate UI ----------
  async function refreshKeyUI(){
    keyLabel.textContent = maskHash(keyHash);

    if(keyHash){
      keyPane.style.display = "none";
      plannerPane.style.display = "block";
      setSync("warn","loading…");
      await pullState();
    } else {
      keyPane.style.display = "block";
      plannerPane.style.display = "none";
      setSync("bad","locked");
    }
  }

  unlockBtn.addEventListener("click", async () => {
    const raw = (keyInput.value || "").trim();
    if(raw.length < 8){
      quickToast("Key too short", "Use 12+ chars ideally.", "warn");
      return;
    }
    keyHash = await sha256Hex(raw);
    localStorage.setItem("PLANNER_KEY_HASH", keyHash);
    keyInput.value = "";
    await refreshKeyUI();
  });

  clearKeyBtn.addEventListener("click", async () => {
    askConfirm("Clear key on this device? (Cloud data remains.)", async () => {
      keyHash = "";
      localStorage.removeItem("PLANNER_KEY_HASH");
      await refreshKeyUI();
      quickToast("Cleared", "Key removed from this device.", "ok");
    });
  });

  pullBtn.addEventListener("click", pullState);
  pushBtn.addEventListener("click", () => pushState(true));

  // ---------- Mode / View ----------
  tabDay.addEventListener("click", ()=>{ mode="day"; render(); });
  tabTemplate.addEventListener("click", ()=>{ mode="template"; render(); });

  tabMain.addEventListener("click", ()=>{ view="main"; render(); });
  tabTimeline.addEventListener("click", ()=>{ view="timeline"; render(); });

  // ---------- Date ----------
  datePick.addEventListener("change", () => {
    selectedDate = datePick.value || toISO(new Date());
    ensureDay(selectedDate);
    markDirty();
    render();
  });

  // ---------- Add panel (no prompts) ----------
  let addType = "todo"; // todo | block

  function showAdd(type){
    addType = type;
    addPanel.style.display = "block";
    addSchedFields.style.display = (type === "block") ? "flex" : "none";
    addTitleLabel.textContent = (type === "block") ? "ADD SCHEDULE" : "ADD CHECKLIST";
    addTypePill.textContent = (type === "block") ? "Schedule Block" : "Checklist Item";
    clearConfirm();
    addTitle.value = "";
    addTitle.focus();
  }

  addTodoBtn.addEventListener("click", ()=> showAdd("todo"));
  addBlockBtn.addEventListener("click", ()=> showAdd("block"));
  hideAddBtn.addEventListener("click", ()=> { addPanel.style.display="none"; clearConfirm(); });

  addCommit.addEventListener("click", () => {
    const title = (addTitle.value || "").trim();
    if(!title){
      quickToast("Missing title", "Type a title and try again.", "warn");
      return;
    }

    const w = workingObj();
    const isDay = (w.type==="day");
    if(isDay && w.obj.locked){
      quickToast("Locked", "This day is locked.", "locked");
      return;
    }

    if(addType === "todo"){
      const t = mkTodo(title);
      w.obj.todos ||= [];
      w.obj.todos.push(t);
      if(isDay){
        w.obj.todoChecks ||= {};
        w.obj.todoChecks[t.id] = false;
      }
      markDirty();
      render();
      quickToast("Added", "Checklist item created.", "ok");
      addTitle.value = "";
      addTitle.focus();
    } else {
      const start = addStart.value || "09:00";
      const dur = Number(addDur.value || 60);
      const tag = addTag.value || "deep";
      const b = mkBlock(title, start, dur, tag);
      w.obj.blocks ||= [];
      w.obj.blocks.push(b);
      markDirty();
      render();
      quickToast("Added", "Schedule block created.", "ok");
      addTitle.value = "";
      addTitle.focus();
    }
  });

  // Apply template → day
  applyTplBtn.addEventListener("click", () => {
    if(mode!=="day") return;
    askConfirm("Overwrite this date with weekday template? (Resets checks + unlocks)", () => {
      const wd = wdMonFirst(parseISO(selectedDate));
      const tpl = state.templates[wd] || { todos:[], blocks:[] };

      ensureDay(selectedDate);
      const day = state.days[selectedDate];

      day.todos = structuredClone(tpl.todos || []);
      day.todoChecks = {};
      for(const t of day.todos) day.todoChecks[t.id] = false;

      day.blocks = structuredClone(tpl.blocks || []);
      day.locked = false;
      day.result = null;

      markDirty();
      render();
      quickToast("Applied", "Template copied into this day.", "ok");
    });
  });

  // Lock day
  lockBtn.addEventListener("click", () => {
    if(mode!=="day") return;
    ensureDay(selectedDate);
    const day = state.days[selectedDate];
    day.result = computeAutoResult(selectedDate);
    day.locked = true;
    markDirty();
    render();
    quickToast("Locked", `Result: ${day.result === "pass" ? "PASS ✅" : "FAIL ❌"}`, day.result==="pass" ? "ok" : "warn");
  });

  // ---------- Boot ----------
  ensureDay(selectedDate);
  render();
  await refreshKeyUI();
</script>
</body>
</html>
